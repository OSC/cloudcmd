<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="robots" content="noindex,nofollow">
        <meta name="theme-color" content="rgb(49,123,249)">
        <!-- mobile first design -->
        <meta content="width=device-width,initial-scale=1" name="viewport">
        <link rel="icon" href="{{ prefix }}/favicon.ico">
        <title>{{ title }}</title>
        
        <link rel=stylesheet href="{{ prefix }}/css/urls.css">
        <!-- OSC_CUSTOM_CODE add custom bootstrap stylesheet path -->
        <link rel=stylesheet href="{{ prefix }}/css/ood_bootstrap.css">
        <link rel=stylesheet href="{{ prefix }}/join:{{ css }}">
        <noscript>
            <link rel=stylesheet href="{{ prefix }}/css/nojs.css">
        </noscript>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.1/jquery.min.js"></script>
<script>
$.noConflict();
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>

    </head>
    <body>
        <div class="fm">{{ fm }}</div>
        <div id="js-keyspanel" class="keyspanel">
            <!-- OSC_CUSTOM_CODE remove this button >> <button id=f1      class="cmd-button reduce-text icon-help"      title="Help"            >F1</button> -->
            <button id=f2      class="cmd-button reduce-text icon-rename"    title="Rename"          >F2</button>
            <button id=f3      class="cmd-button reduce-text icon-view"      title="View"            >F3</button>
            <button id=f4      class="cmd-button reduce-text icon-edit "     title="Edit"            >F4</button>
            <button id=f5      class="cmd-button reduce-text icon-copy"      title="Copy"            >F5</button>
            <button id=f6      class="cmd-button reduce-text icon-move"      title="Move"            >F6</button>
            <button id=f7      class="cmd-button reduce-text icon-directory" title="New Directory"   >F7</button>
            <button id=f8      class="cmd-button reduce-text icon-delete"    title="Delete"          >F8</button>
            <button id=f9      class="cmd-button reduce-text icon-menu"      title="Menu"            >F9</button>
            <button id=f10     class="cmd-button reduce-text icon-config"    title="Config"          >F10</button>
            <!-- OSC_CUSTOM_CODE Convert console button to a link to wetty and remove the original defaults -->
            <a onclick='window.open(CloudFunc.getWettyLink(CloudFunc.Path))' target="_blank"><button id=wetty       class="cmd-button reduce-text icon-console"   title="Wetty">~</button></a>
            <!-- OSC_CUSTOM_CODE remove this button >> <button id=contact class="cmd-button reduce-text icon-contact"   title="Contact"         ></button> -->
        </div>
        <script src="{{ prefix }}/cloudcmd.js"></script>
        <script>
            CloudCmd('{{ prefix }}');

            function terminal() {
                var terminal_path = '/pun/sys/shell/ssh/oakley';
                window.open(terminal_path + DOM.getCurrentDirPath());
            }

            // OSC_CUSTOM_CODE publicize download method from lib/client/menu.js
            function download() {
                var TIME        = 30 * 1000,
                        prefixUr    = CloudCmd.PREFIX_URL,
                        FS          = CloudFunc.FS,
                        PACK        = '/pack',
                        date        = Date.now(),
                        files       = DOM.getActiveFiles();

                if (!files.length)
                    DOM.Dialog.alert.noFiles();
                else
                    files.forEach(function(file) {
                        var element,
                                selected    = DOM.isSelected(file),
                                path        = DOM.getCurrentPath(file),
                                id          = DOM.load.getIdBySrc(path),
                                isDir       = DOM.isCurrentIsDir(file);

                        CloudCmd.log('downloading file ' + path + '...');

                        if (isDir)
                            path        = prefixUr + PACK + path + '.tar.gz';
                        else
                            path        = prefixUr + FS + path + '?download';

                        element     = DOM.load({
                            id          : id + '-' + date,
                            name        : 'iframe',
                            async       : false,
                            className   : 'hidden',
                            src         : path
                        });

                        setTimeout(function() {
                            document.body.removeChild(element);
                        }, TIME);

                        if (selected)
                            DOM.toggleSelectedFile(file);
                    });
            }
// not sure how to style yet as icon: "mini-icon directory" works...
// but doesn't
jQuery('#directory-tree').jstree({
    'core' : {
      'multiple' : false,
      'data' : {
        url: function(node){
          console.log(node);
          if(node.id == "#")
            return "https://websvcs08.osc.edu/pun/dev/files/api/v1/fs/nfs/17/efranz";
          else
            return "https://websvcs08.osc.edu/pun/dev/files/api/v1/fs" + node.id;
        },
        dataFilter: function(data, type){
          var parsed_data = JSON.parse(data);
          return JSON.stringify(parsed_data.files.filter(function(arg){
              return (! arg.name.startsWith(".")) && arg.size == "dir";
          }).map(function(arg){
              // how do we know if it is a leaf node? we do not :-(
              // solution - we need to have a CUSTOM request that actually
              // returns whether or not the directory CONTAINS any subdirectories
              // THUS our own request/response in front of the api request/response
              // but this works well now...
              return {text: arg.name, children: true, id: parsed_data.path + arg.name}; // add id or attribute for full path
          }));
        }
      }
    }
});

jQuery('#directory-tree').on('changed.jstree', function(e, data){
  console.log("select_node.jstree event fired: ");
  console.log(e);
  console.log(data.node.id);

  //TODO: may have to massage data.node.id
  // in lib/client/listeners.js this was done:
  //
  // link        = link.replace('%%', '%25%');
  // link        = decodeURI(link);
  // link        = link.replace(RegExp('^' + prefix + fs), '') || '/';
  CloudCmd.loadDir({
    path: data.node.id,
    isRefresh: false,
    panel: DOM.getByDataName('js-left')
  });
});

window.updateTreeSelection = function(){
  var tree = jQuery('#directory-tree').jstree(true);
  tree.deselect_all(true);
  tree.select_node(DOM.getCurrentDirPath().slice(0,-1), true);
};

        </script>
    </body>
</html>
